# This is a cookbook which simulates a simple 2D subduction system with
# a hydrated sediment layer, MORB layer, gabbro layer, and peridotite
# layer. The layers dehydrate as they are subducted, with the solid-fluid
# reactions governed by an approximation published by Tian et al., 2018.
# 1. i1 = iterated Advection and Newton Stokes vs 12 = iterated Advection and Stokes
# 2. Try linear solver tolerance of l1= 1e-8, l2= 1e-7, l3=1e-6
# 3. Try nonlinear solver tolerance of n1= 1e-5 vs n2 = 1e-6, n3 = 1e-4, 
#After tests 1-3, try do harmonic versus geometric averaging again 
#(both the averaging over the entire element and between fields should both be set to either harmonic or geometric)
# 4. g0/gnone= AMG, g1=GmG
# 5. o0none= 1node, o1= using 1 node
# 6. Number of cheap Stokes solver steps none/0= 20000, c1= 50000
# 7. Maximum number of expensive Stokes solver steps none/0 = 0, e1= 1000
# 8. GMRES solver restart length: g0/none= 1000, g1= 200
# 9. Maximum first time step: f0/none = 1000, f1= 500
#10. max_nonlinear iterations m0/none = 200, m1=2000 

# set World builder file                         = adiabat.wb
set World builder file                         = original.wb
set Adiabatic surface temperature              = 1573
set Nonlinear solver scheme                    = iterated Advection and Stokes

set Nonlinear solver failure strategy          = continue with next timestep
set Output directory                           = isentropic_adiabat_new_boundary

set Max nonlinear iterations                   = 100
set Nonlinear solver tolerance                 = 5e-2
set Dimension                                  = 2

set Max nonlinear iterations                   = 200
set End time                                   = 100e3
set CFL number                                 = 0.1

# Using a free surface, so we must disable surface pressure
# set Surface pressure                           = 0
set Pressure normalization                     = no
set Maximum time step                          = 10000
set Maximum first time step                    = 100
set Maximum relative increase in time step     = 50.0
set Use operator splitting                     = false
set Resume computation                         = auto

subsection Solver parameters
  subsection Stokes solver parameters
    set Stokes solver type                              = block AMG 
    set GMRES solver restart length                     = 1000 # next test: 50 - 150
    set Number of cheap Stokes solver steps             = 20000 
    set Use full A block as preconditioner              = true
    set Linear solver tolerance                         = 5e-5  #test2: start with 1e-8:  1e-6 vs 1e-8
    set Maximum number of expensive Stokes solver steps = 0
  end
  subsection Operator splitting parameters
    set Reaction solver type                   = fixed step
    set Reaction time step                     = 50
    set Reaction time steps per advection step = 50
  end
end

subsection Time stepping
  subsection Repeat on nonlinear solver failure
    set Cut back factor = 0.25
  end
end

subsection Discretization
  subsection Stabilization parameters
    set beta  = 0.052
    set cR    = 0.11
  end
end

subsection Checkpointing
  set Steps between checkpoint = 10
end

subsection Compositional fields
  set Number of fields            = 7
  set Names of fields             = porosity, bound_fluid, peridotite, gabbro,    MORB,      sediment,  overriding
  set Compositional field methods = field,    field,       particles,  particles, particles, particles, particles
  set Mapped particle properties  = peridotite: initial peridotite, \
                                    gabbro: initial gabbro, \
                                    MORB: initial MORB, \
                                    sediment: initial sediment, \
                                    overriding: initial overriding
end

subsection Temperature field
  set Temperature method = field
end

subsection Initial composition model
  set List of model names = world builder
  subsection World builder
    set List of relevant compositions = porosity, bound_fluid, peridotite, gabbro, MORB, sediment, overriding
  end
end

# ############### mesh deforamtion ###############
subsection Mesh deformation
  set Mesh deformation boundary indicators = top: free surface & diffusion
  set Additional tangential mesh velocity boundary indicators = left,right
  subsection Free surface
    set Free surface stabilization theta   = 0.5
    set Surface velocity projection        = normal
  end
  subsection Diffusion
    set Hillslope transport coefficient = 1e-6
  end
end
subsection Particles
  set Minimum particles per cell  = 25
  set Maximum particles per cell  = 100
  set Load balancing strategy     = remove and add particles
  set List of particle properties = initial composition, pT path, position
  set Interpolation scheme        = bilinear least squares
  set Update ghost particles      = true
  set Particle generator name     = reference cell
  subsection Generator
    subsection Reference cell
      set Number of particles per cell per direction = 7
    end
  end
end
subsection Geometry model
  set Model name = box
  subsection Box
    set X extent      = 8700e3
    set Y extent      = 2900e3

    set X repetitions = 6
    set Y repetitions = 2

    set Box origin X coordinate = 0
    set Box origin Y coordinate = 0
  end
end


subsection Gravity model
  set Model name = function
  subsection Function
    set Variable names      = x,y
    set Function expression = 0; -9.81
  end
end

subsection Formulation
  set Mass conservation    = isentropic compression
  set Temperature equation = real density
end

subsection Initial temperature model
  set Model name = world builder
end

subsection Boundary temperature model
  set List of model names = constant
  set Fixed temperature boundary indicators   = top, bottom

  subsection Constant
    set Boundary indicator to temperature mappings = bottom:3113.5407714843764, top:273
  end
end

subsection Heating model
  set List of model names = adiabatic heating, shear heating
end

subsection Material model

  set Model name         = compositing
  set Material averaging = geometric average only viscosity

#  subsection Reactive Fluid Transport Model
#    set Base model                                       = visco plastic
#    set Reference fluid density                          = 1000
#    set Shear to bulk viscosity ratio                    = 0.1
#    set Reference fluid viscosity                        = 1
#    set Reference permeability                           = 5e-7
#    set Exponential fluid weakening factor               = 30
#    set Fluid compressibility                            = 0
#    set Fluid reaction time scale for operator splitting = 5e4
#    set Fluid-solid reaction scheme                      = tian approximation
#    subsection Tian 2019 model
#      # set Maximum weight percent water in peridotite       = 2
#      # set Maximum weight percent water in gabbro           = 1
#      # set Maximum weight percent water in MORB             = 2
#      # set Maximum weight percent water in sediment         = 3
#    end
#  end

  subsection Multicomponent compressible
    set Reference temperatures                       = 1600
    set Reference densities                          = background: 3300,   porosity: 3300,  bound_fluid: 3300,  peridotite: 3300,  gabbro: 3175,  MORB: 3175,  sediment: 3175, overriding: 3175
    set Reference isothermal compressibilities       = 4e-12
    set Isothermal bulk modulus pressure derivatives = 4
    set Reference thermal expansivities              = 2.e-5
    set Isochoric specific heats                     = 1250
    set Thermal conductivities                       = 0.0
  end

  subsection Visco Plastic
    set Viscosity averaging scheme        = geometric
    set Viscous flow law                  = composite
    set Use plastic damper                = true
    set Plastic damper viscosity          = 1e20

    set Viscosity prefactor scheme        = HK04 olivine hydration
    set Minimum strain rate               = 1e-20
    set Reference strain rate             = 1e-20

    set Phase transition depths           =   background: 660e3,  porosity: 660e3, bound_fluid: 660e3, peridotite: 660e3, gabbro: 660e3, MORB: 125e3|660e3, sediment: 125e3|660e3, overriding: 660e3
    set Phase transition widths           =   background: 20e3,   porosity: 20e3,  bound_fluid: 20e3,  peridotite: 20e3,  gabbro: 20e3,  MORB: 10e3|20e3,   sediment: 10e3|20e3,   overriding: 20e3
    set Phase transition temperatures     =   background: 1573,   porosity: 1573,  bound_fluid: 1573,  peridotite: 1573,  gabbro: 1573,  MORB: 1573|1573,   sediment: 1573|1573,   overriding: 1573
    set Phase transition Clapeyron slopes =   background: 0,      porosity: 0,     bound_fluid: 0,     peridotite: 0,     gabbro: 0,     MORB: 0|0,         sediment: 0|0,         overriding: 0

    set Densities                         =   background: 3300,   porosity: 3300,  bound_fluid: 3300,  peridotite: 3300,  gabbro: 3300,  MORB: 3300,        sediment: 3300,        overriding: 3300

    set Minimum viscosity   =   background: 2.5e18|2.5e18,  porosity: 2.5e18|2.5e18, bound_fluid: 2.5e18|2.5e18, peridotite: 2.5e18|2.5e18, gabbro: 2.5e18|2.5e18, MORB: 2.499e19|2.5e18|2.5e18, sediment: 2.499e19|2.5e18|2.5e18, overriding: 2.5e18|2.5e18 # next step: 2.5e18 to 2.5e24
    set Maximum viscosity   =   background: 2.5e23|2.5e23,  porosity: 2.5e23|2.5e23, bound_fluid: 2.5e23|2.5e23, peridotite: 2.5e23|2.5e23, gabbro: 2.5e23|2.5e23, MORB: 2.501e19|2.5e23|2.5e23, sediment: 2.501e19|2.5e23|2.5e23, overriding: 2.5e23|2.5e23
    # units in Hirth&Kohlstedt_2000: fH20: MPa, stress in MPa,  grainsize 1e-6 m
    # units in Aspect:               fH20: Pa, stress in Pa, grainsize in m
    # diffusion     1.5e9*1e-6*1e-18 = 1.5e-15
    # dislocation   1.1e5*1e-6*1e-18 = 1.1e-19
    
    set Prefactors for diffusion creep                    = background:  1.577e-22|8.0e-25, \
                                                            porosity:    1.577e-22|8.0e-25, \
                                                            bound_fluid: 1.577e-22|8.0e-25, \
                                                            peridotite:  1.577e-22|8.0e-25, \
                                                            gabbro:      1.577e-22|8.0e-25, \
                                                            MORB:        1.577e-22|1.577e-22|8.0e-25, \
                                                            sediment:    1.577e-22|1.577e-22|8.0e-25, \
                                                            overriding:  1.577e-22|8.0e-25

    set Water fugacity exponents for diffusion creep      = 0.7

    set Stress exponents for diffusion creep              = 1.0
    set Grain size exponents for diffusion creep          = 3

    set Activation volumes for diffusion creep            = background:  11.3e-6|9.8e-6, \
                                                            porosity:    11.3e-6|9.8e-6, \
                                                            bound_fluid: 11.3e-6|9.8e-6, \
                                                            peridotite:  11.3e-6|9.8e-6, \
                                                            gabbro:      11.3e-6|9.8e-6, \
                                                            MORB:        11.3e-6|11.3e-6|9.8e-6, \
                                                            sediment:    11.3e-6|11.3e-6|9.8e-6, \
                                                            overriding:  11.3e-6|10e-6

    set Grain size                                        = 1e-3

    set Activation energies for diffusion creep           = 375e3

    set Prefactors for dislocation creep                  = background:  2.75e-26|1e-50, \
                                                            porosity:    2.75e-26|1e-50, \
                                                            bound_fluid: 2.75e-26|1e-50, \
                                                            peridotite:  2.75e-26|1e-50, \
                                                            gabbro:      2.75e-26|1e-50, \
                                                            MORB:        2.75e-26|2.75e-26|1e-50, \
                                                            sediment:    2.75e-26|2.75e-26|1e-50, \
                                                            overriding:  2.75e-26|1e-50, \

    set Water fugacity exponents for dislocation creep    = 0.34285714285714286

    set Stress exponents for dislocation creep            = 3.5

    set Activation volumes for dislocation creep          = 22e-6

    set Activation energies for dislocation creep         = 520e3

    set Angles of internal friction                       = 30

    set Cohesions                                         = 60e6

    set Maximum yield stress                              = 500e6 

    set Use adiabatic pressure in plasticity              = true

    set Thermal expansivities                             = 3.0e-5
    set Thermal diffusivities                             = 1e-6
    set Heat capacities                                   = 750
  end

  subsection Compositing
    set Viscosity                      = visco plastic
    set Density                        = multicomponent compressible
    set Thermal expansion coefficient  = multicomponent compressible
    set Specific heat                  = multicomponent compressible
    set Thermal conductivity           = multicomponent compressible
    set Compressibility                = multicomponent compressible
    set Entropy derivative pressure    = multicomponent compressible
    set Entropy derivative temperature = multicomponent compressible
    set Reaction terms                 = multicomponent compressible
  end
end

subsection Mesh refinement
  set Coarsening fraction                      = 0.3
  set Refinement fraction                      = 0.5
  set Initial adaptive refinement              = 4
  set Initial global refinement                = 6
  set Strategy                                 = viscosity, composition threshold, minimum refinement function, maximum refinement function
  set Time steps between mesh refinement       = 2
  set Refinement criteria scaling factors      = 2, 2, 1, 1
  set Refinement criteria merge operation      = max
  set Run postprocessors on initial refinement = false
  set Skip solvers on initial refinement       = true

  # minimum of 4 global refinements
  subsection Minimum refinement function
    set Function constants  = litho_thickness=120e3, ymax=2900e3
    set Coordinate system   = cartesian
    set Variable names      = x, y
    set Function expression = if(y>(ymax-litho_thickness),6, \
                              if(y>=(ymax - 662e3) && y<=(ymax - 658e3), 5, 4))
  end

  subsection Maximum refinement function
    set Function constants  = xmax=5500e3, xmin=4000e3, ymax=2900e3
    set Coordinate system   = cartesian
    set Variable names      = x, y
    set Function expression = if( x<=xmax && x>=xmin && y>=(ymax - 660e3), 10, 8)
  end

  # refine where the porosity is bigger than 1e-6
  # porosity, bound_fluid, peridotite, gabbro, MORB, sediment, overriding
  subsection Composition threshold
    set Compositional field thresholds = 1e-6, 0.005, 10.0, 10.0, 0.5, 0.5, 10.0
  end
end

subsection Boundary velocity model
  set Tangential velocity boundary indicators = left, right, bottom
end

subsection Melt settings
  set Include melt transport                  = false
end

subsection Postprocess
  set List of postprocessors = visualization, composition statistics, velocity statistics, particles, material statistics
  subsection Visualization
    set List of output variables      = material properties, strain rate, named additional outputs, stress second invariant, depth, heat flux map
    set Output format                 = vtu
    set Time between graphical output = 100e3
    set Interpolate output            = true
    set Number of grouped files       = 0
    subsection Material properties
      set List of material properties = density, viscosity
    end
  end
  subsection Particles
    set Time between data output      = 100e3
    set Data output format            = vtu
  end
end
